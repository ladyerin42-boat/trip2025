<script>
  const repoOwner = "ladyerin42-boat";
  const repoName = "trip2025";
  const filePath = "markers.json";
  const branch = "main";

  // ⛔ Replace with your PAT
  const token = "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";

  let markers = [];
  let sha = "";

  // Initialize map
  const map = L.map('map').setView([-20.2762, 148.7550], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  // Create a layer group to manage markers
  const markerLayer = L.layerGroup().addTo(map);

  // Add click handler to populate form
  map.on('click', e => {
    document.getElementById('lat').value = e.latlng.lat.toFixed(6);
    document.getElementById('lng').value = e.latlng.lng.toFixed(6);
  });

  async function loadMarkers() {
    const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}?ref=${branch}`;
    const res = await fetch(url, {
      headers: { Authorization: `token ${token}` }
    });
    const data = await res.json();
    sha = data.sha;
    markers = JSON.parse(atob(data.content));
    renderMarkers();
  }

  function renderMarkers() {
    // clear table
    document.getElementById('markerTable').innerHTML = "";

    // clear map layer
    markerLayer.clearLayers();

    markers.forEach((m, i) => {
      // table row
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${m.name}</td>
        <td>${m.lat}</td>
        <td>${m.lng}</td>
        <td><button onclick="deleteMarker(${i})">Delete</button></td>
      `;
      document.getElementById('markerTable').appendChild(row);

      // map marker
      L.marker([m.lat, m.lng])
        .addTo(markerLayer)
        .bindPopup(`<a href="${m.link}" target="_blank">View</a>`);
    });
  }

  function addMarker() {
    const name = document.getElementById('name').value;
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    const link = document.getElementById('link').value;
    if (!name || isNaN(lat) || isNaN(lng)) {
      alert("Please enter name, lat, lng");
      return;
    }
    markers.push({ name, lat, lng, link });
    renderMarkers();
  }
   
  function deleteMarker(i) {
    markers.splice(i, 1);
    renderMarkers();
  }

  async function saveMarkers() {
    const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
    const content = btoa(JSON.stringify(markers, null, 2));
    const res = await fetch(url, {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update markers.json via editor",
        content: content,
        sha: sha,
        branch: branch
      })
    });
    const data = await res.json();
    alert("Saved to GitHub!");
    sha = data.content.sha;
  }
</script>
