<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Marker Editor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; padding:0; display:flex; height:100vh; font-family: Arial, sans-serif; }
    #map { flex:2; }
    #sidebar { flex:1; padding:10px; overflow:auto; border-left: 1px solid #ccc; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 6px; text-align: left; }
    input[type="text"] { width: 95%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h2>Marker Editor</h2>
    <form id="markerForm">
      <label>Title: <input type="text" id="title" required></label><br>
      <label>Link: <input type="text" id="link" required></label><br>
      <label>Latitude: <input type="text" id="lat" required></label><br>
      <label>Longitude: <input type="text" id="lng" required></label><br>
      <button type="submit">Add Marker</button>
    </form>
    <button id="downloadBtn">Download markers.json</button>
    <h3>Current Markers</h3>
    <table id="markerTable">
      <thead><tr><th>Title</th><th>Link</th><th>Lat</th><th>Lng</th><th>Delete</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([-20.28, 148.92], 9); // Whitsundays area
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    // Load existing markers.json
    fetch('markers.json')
      .then(res => res.json())
      .then(data => {
        markers = data;
        refreshTable();
        renderMarkers();
      })
      .catch(() => console.log("No markers.json found yet"));

    // Click on map populates lat/lng fields
    map.on('click', function(e) {
      document.getElementById('lat').value = e.latlng.lat.toFixed(6);
      document.getElementById('lng').value = e.latlng.lng.toFixed(6);
    });

    // Add new marker
    document.getElementById('markerForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const newMarker = {
        title: document.getElementById('title').value,
        link: document.getElementById('link').value,
        lat: parseFloat(document.getElementById('lat').value),
        lng: parseFloat(document.getElementById('lng').value)
      };
      markers.push(newMarker);
      refreshTable();
      renderMarkers();
      this.reset();
    });

    // Refresh table
    function refreshTable() {
      const tbody = document.querySelector('#markerTable tbody');
      tbody.innerHTML = '';
      markers.forEach((m, i) => {
        let row = `<tr>
          <td>${m.title}</td>
          <td><a href="${m.link}" target="_blank">View</a></td>
          <td>${m.lat}</td>
          <td>${m.lng}</td>
          <td><button onclick="deleteMarker(${i})">Delete</button></td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    // Render markers on map
    function renderMarkers() {
      if (window.currentLayer) {
        map.removeLayer(window.currentLayer);
      }
      window.currentLayer = L.layerGroup();
      markers.forEach(m => {
        L.marker([m.lat, m.lng])
          .bindPopup(`<b>${m.title}</b><br><a href="${m.link}" target="_blank">View</a>`)
          .addTo(window.currentLayer);
      });
      window.currentLayer.addTo(map);
    }

    // Delete marker
    function deleteMarker(index) {
      markers.splice(index, 1);
      refreshTable();
      renderMarkers();
    }

    // Download updated markers.json
    document.getElementById('downloadBtn').addEventListener('click', function() {
      const blob = new Blob([JSON.stringify(markers, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "markers.json";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
