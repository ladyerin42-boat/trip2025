<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lady Erin - Trip Marker Editor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      display: flex;
      margin: 0;
      height: 100vh;
    }
    #map {
      flex: 2;
    }
    #sidebar {
      flex: 1;
      overflow-y: auto;
      border-left: 1px solid #dee2e6;
      padding: 1rem;
      background-color: #f8f9fa;
    }
    #markerTable th, #markerTable td {
      font-size: 0.9rem;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div id="map" class="border-end shadow-sm"></div>
  <div id="sidebar">
    <h2 class="h4 mb-3">Marker Editor</h2>
    <form id="markerForm" class="mb-3">
      <input type="text" id="name" class="form-control mb-2" placeholder="Name" required>
      <input type="text" id="lat" class="form-control mb-2" placeholder="Latitude" required>
      <input type="text" id="lng" class="form-control mb-2" placeholder="Longitude" required>
      <input type="text" id="url" class="form-control mb-2" placeholder="URL" required>
      <button type="submit" class="btn btn-primary w-100">Add Marker</button>
    </form>

    <h3 class="h5">Markers</h3>
    <div class="table-responsive mb-3">
      <table id="markerTable" class="table table-striped table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>URL</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button id="download" class="btn btn-success w-100">Download markers.json</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([-20.3, 148.9], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    let markers = [];
    let tableBody = document.querySelector('#markerTable tbody');

    // Custom ship marker icon
    const shipIcon = L.icon({
      iconUrl: 'edit.png',  // <- put your PNG file here
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    // The file to be updated
    const defaultFile = 'south_2025.json';

    // Load the current trip JSON file
    fetch(defaultFile)
      .then(response => response.json())
      .then(data => {
        markers = data;
        renderMarkers();

        if (markers.length > 0) {
          const last = markers[markers.length - 1];
          map.setView([last.lat, last.lng], 13);
        }
      });

    // Add marker on form submit
    document.getElementById('markerForm').addEventListener('submit', e => {
      e.preventDefault();
      let name = document.getElementById('name').value;
      let lat = parseFloat(document.getElementById('lat').value);
      let lng = parseFloat(document.getElementById('lng').value);
      let url = document.getElementById('url').value;

      let newMarker = { name, lat, lng, url };
      markers.push(newMarker);
      renderMarkers();
      map.setView([lat, lng], 13);
      e.target.reset();
    });

    // Click map to prefill lat/lng
    map.on('click', e => {
      document.getElementById('lat').value = e.latlng.lat.toFixed(6);
      document.getElementById('lng').value = e.latlng.lng.toFixed(6);
    });

    function renderMarkers() {
      tableBody.innerHTML = '';
      map.eachLayer(layer => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });

      markers.forEach((m, index) => {
        const url = (m.url ?? '').toString();
        const displayUrl = url.trim() !== '' ? `<a href="${url}" target="_blank">View</a>` : 'No link';

        // Marker popup
        L.marker([m.lat, m.lng], { icon: shipIcon })
          .addTo(map)
          .bindPopup(`<b>${m.name}</b><br>${displayUrl}`);

        // Table row
        let row = document.createElement('tr');
        row.innerHTML = `
          <td>${m.name}</td>
          <td>${m.lat}</td>
          <td>${m.lng}</td>
          <td>${displayUrl}</td>
          <td><button class="btn btn-sm btn-danger" onclick="deleteMarker(${index})">X</button></td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Delete marker
    function deleteMarker(index) {
      markers.splice(index, 1);
      renderMarkers();
      if (markers.length > 0) {
        const last = markers[markers.length - 1];
        map.setView([last.lat, last.lng], 13);
      }
    }
    window.deleteMarker = deleteMarker;

    // Download updated markers.json
    document.getElementById('download').addEventListener('click', () => {
      let blob = new Blob([JSON.stringify(markers, null, 2)], { type: 'application/json' });
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = defaultFile;
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
