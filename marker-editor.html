<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lady Erin - Trip Marker Editor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
    }
    #map {
      height: 100vh;
      width: 70%;
    }
    #sidebar {
      width: 30%;
      padding: 10px;
      overflow-y: auto;
      border-left: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    input, button {
      margin: 5px 0;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h2>Marker Editor</h2>
    <form id="markerForm">
      <input type="text" id="name" placeholder="Name" required>
      <input type="text" id="lat" placeholder="Latitude" required>
      <input type="text" id="lng" placeholder="Longitude" required>
      <input type="text" id="url" placeholder="URL" required>
      <button type="submit">Add Marker</button>
    </form>

    <h3>Markers</h3>
    <table id="markerTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Lat</th>
          <th>Lng</th>
          <th>URL</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="download">Download markers.json</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([-20.3, 148.9], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    let markers = [];
    let tableBody = document.querySelector('#markerTable tbody');

    // Custom ship marker icon
    const shipIcon = L.icon({
      iconUrl: 'edit.png',  // <- put your PNG file here
      iconSize: [32, 32],   // size of the icon
      iconAnchor: [16, 32], // point of the icon which corresponds to marker's location
      popupAnchor: [0, -32] // point from which the popup should open
    });

    // The file to be updated
    const defaultFile = 'south_2025.json';

    // Load the current trip JSON file
    fetch(defaultFile)
      .then(response => response.json())
      .then(data => {
        markers = data;
        renderMarkers();

        if (markers.length > 0) {
          const last = markers[markers.length - 1];
          map.setView([last.lat, last.lng], 13);
        }
      });

    // Add marker on form submit
    document.getElementById('markerForm').addEventListener('submit', e => {
      e.preventDefault();
      let name = document.getElementById('name').value;
      let lat = parseFloat(document.getElementById('lat').value);
      let lng = parseFloat(document.getElementById('lng').value);
      let url = document.getElementById('url').value;

      let newMarker = { name, lat, lng, url };
      markers.push(newMarker);
      renderMarkers();
      map.setView([lat, lng], 13);
      e.target.reset();
    });

    // Click map to prefill lat/lng
    map.on('click', e => {
      document.getElementById('lat').value = e.latlng.lat.toFixed(6);
      document.getElementById('lng').value = e.latlng.lng.toFixed(6);
    });

    // Render markers on map and in table
    function renderMarkers() {
      tableBody.innerHTML = '';
      map.eachLayer(layer => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });

      markers.forEach((m, index) => {
        // Add to map with custom icon
        L.marker([m.lat, m.lng], { icon: shipIcon })
          .addTo(map)
          .bindPopup(`<b>${m.name}</b><br><a href="${m.url}" target="_blank">View</a>`);

        // Add to table
        let row = document.createElement('tr');
        row.innerHTML = `
          <td>${m.name}</td>
          <td>${m.lat}</td>
          <td>${m.lng}</td>
          <td><a href="${m.url}" target="_blank">View</a></td>
          <td><button onclick="deleteMarker(${index})">X</button></td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Delete marker
    function deleteMarker(index) {
      markers.splice(index, 1);
      renderMarkers();
      if (markers.length > 0) {
        const last = markers[markers.length - 1];
        map.setView([last.lat, last.lng], 13);
      }
    }
    window.deleteMarker = deleteMarker;

    // Download updated markers.json
    document.getElementById('download').addEventListener('click', () => {
      let blob = new Blob([JSON.stringify(markers, null, 2)], { type: 'application/json' });
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = defaultFile;
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
