<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Lady Erin - Trip Viewer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    margin:0;
    font-family: Arial, sans-serif;
    display:flex;
    flex-direction:column;
    height:100vh;
  }
  #controls {
    padding:10px;
    background:#f7f7f7;
    border-bottom:1px solid #ddd;
  }
  #map { flex:1; height: 70vh; }
  #table-container {
    padding:10px;
    height: 30vh;
    overflow:auto;
    background:#fff;
  }
  table th, table td { vertical-align: middle; }
</style>
</head>
<body>

<div id="controls" class="d-flex align-items-center gap-2 flex-wrap">
  <label for="jsonFile" class="form-label mb-0">Choose trip file:</label>
  <select id="jsonFile" class="form-select form-select-sm" style="width:auto;">
    <option value="south_2025.json">South (Sept-November 2025)</option>
    <option value="north_2025.json">North (July-August 2025)</option>
  </select>
  <button id="loadBtn" type="button" class="btn btn-primary btn-sm">Load</button>
  <span id="status" class="ms-2 text-muted"></span>
</div>

<div id="map" class="border-bottom shadow-sm"></div>

<div id="table-container">
  <h3 class="h5">Markers</h3>
  <div class="table-responsive">
    <table id="markerTable" class="table table-striped table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>Name</th><th>Lat</th><th>Lng</th><th>URL</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
(() => {
  const defaultFile = 'south_2025.json';
  const select = document.getElementById('jsonFile');
  const loadBtn = document.getElementById('loadBtn');
  const status = document.getElementById('status');
  const tableBody = document.querySelector('#markerTable tbody');

  // Init map
  const map = L.map('map').setView([-20.2762, 148.7550], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);
  const markerLayer = L.layerGroup().addTo(map);

  // Custom ship icon
  const shipIcon = L.icon({
    iconUrl: 'marker.png',    
    iconSize: [32, 32],     
    iconAnchor: [16, 32],   
    popupAnchor: [0, -32]   
  });

  function setStatus(msg, isError=false) {
    status.textContent = msg || '';
    status.style.color = isError ? 'crimson' : '#666';
    console.log(msg);
  }

 async function loadMarkers(file) {
  file = file || defaultFile;
  setStatus(`Loading ${file}...`);
  markerLayer.clearLayers();
  tableBody.innerHTML = '';

  try {
    const url = file + '?nocache=' + Date.now();
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} - ${url}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('JSON is not an array of markers');

    setStatus(`Loaded ${data.length} markers`);
    const bounds = [];

    data.forEach(m => {
      const url = (m.url ?? m.link ?? '').toString();
      const lat = Number(m.lat);
      const lng = Number(m.lng);
      const name = m.name ?? '';
      if (!isFinite(lat) || !isFinite(lng)) return;

      // Decide what to show for empty URLs
      const displayUrl = url.trim() !== '' 
                         ? `<a href="${escapeHtml(url)}" target="_blank">View</a>` 
                         : 'No link';

      // Add marker with popup respecting empty URL
      L.marker([lat, lng], { icon: shipIcon }).addTo(markerLayer)
        .bindPopup(`<b>${escapeHtml(name)}</b><br>${displayUrl}`);

      // Add row to table
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escapeHtml(name)}</td>
        <td>${lat}</td>
        <td>${lng}</td>
        <td>${displayUrl}</td>
      `;
      tableBody.appendChild(row);

      bounds.push([lat, lng]);
    });

    if (bounds.length) map.fitBounds(bounds, { padding: [40, 40] });
  } catch (err) {
    console.error(err);
    setStatus('Failed to load markers: ' + err.message, true);
  }
}

  function escapeHtml(s) {
    if (!s) return '';
    return s.replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;');
  }

  loadBtn.addEventListener('click', () => {
    const file = select.value || defaultFile;
    loadMarkers(file);
  });

  window.addEventListener('DOMContentLoaded', () => loadMarkers(defaultFile));
})();
</script>
</body>
</html>
 